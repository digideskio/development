<!DOCTYPE html>
<meta charset="utf-8">
<style>

.link {
  fill: none;
  stroke: #000;
}

.node {
  stroke: #fff;
}

</style>
<body>
<script src="../d3.v2.js"></script>
<script>

var margin = {top: 40, right: 40, bottom: 40, left: 40},
    width = 1500 - margin.left - margin.right,
    height = 1500 - margin.top - margin.bottom;
var cScale=d3.scale.linear().domain([2004,2008,2012]).range(["purple","#eee","blue"]);
var fScale=d3.scale.linear().domain([0,10,100]).range([0,12,48]).clamp([true]);
var pack = d3.layout.pack()
    .size([width - 4, height - 4])
    .value(function(d) { return d.size; });

var svg = d3.select("body").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
  .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
var data,n,debugD;
d3.csv("min.csv", function(csv) {
  data=csv;
   var myN=d3.nest()
    //.key(function(d) {return d.Directorate;})
    //.key(function(d) {return d.Deparment;})
    .key(function(d) {return d.From;})
    .map(csv);
n={name:"emails",children:[]};
var lastDir=-1,lastFrom=-1,lastDep=-1;
/*data.forEach(function(d) {debugD=d;
if (d.Directorate!==lastDir) {
  
  n.children.push({name:d.Directorate,children:[]});
  lastDir=d.Directorate;lastDep=-1;lastFrom=-1;}
var myDir=n.children[n.children.length-1];
if (d.Department!==lastDep) {
  myDir.children.push({name:d.Department,children:[]});
  lastDep=d.Department,lastFrom=-1;}
var myDep=myDir.children[myDir.children.length-1];
if (d.From!==lastFrom) {
  myDep.children.push({name:d.From,children:[]});
  lastFrom=d.From;}
var myFrom=myDep.children[myDep.children.length-1];
myFrom.children.push({name:d.From,subject:d.Subject,year:+d.year,size:+d.Len});
})*/

data.forEach(function(d) {debugD=d;
if (d.From!==lastFrom) {
  n.children.push({name:d.From,children:[]});
  lastFrom=d.From;}
var myFrom=n.children[n.children.length-1];
myFrom.children.push({name:d.From,subject:d.Subject,year:+d.year,size:+d.Len});
})
console.log("data arranged");
  var node = svg.data([n]).selectAll("g.node")
      .data(pack.nodes)
    .enter().append("g")
      .attr("class", function(d) { return d.children ? "node node"+d.depth : "leaf node"; })
      .attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });
      
  

  //node.append("title")
  //    .text(function(d) { return d.name + (d.children ? "" : ": " + format(d.size)); });

  node.append("circle")
      .attr("r", function(d) { return d.r; })
      .style("stroke","#888")
      //.style("fill",function(d) {return d.depth===2 ? cScale(d.year) : "none";})
      //.style("stroke",function(d) {return d.depth===2 ? "none":"#eee"})

  d3.selectAll(".node1").append("text").text(function(d) {return d.name;})
    .attr("text-anchor","middle")
    .style("visibility",function(d) {return d.children.length>=10?"visible":"hidden"})
    .style("font-size",function(d) {return fScale(d.children.length);});
    

  /*node.filter(function(d) { return !d.children; }).append("text")
      .attr("text-anchor", "middle")
      .attr("dy", ".3em")
      .text(function(d) { return d.name.substring(0, d.r / 3); });*/
});

</script>